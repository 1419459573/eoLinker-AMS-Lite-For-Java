"use strict";!function(){var t=angular.module("angularQFileUpload",["LocalStorageModule"]);t.service("$qupload",["$http","$q","localStorageService",function(t,e,i){function o(t){var e,i,o,r;for(e="",o=t.length,i=0;i<o;i++)r=t.charCodeAt(i),r>=1&&r<=127?e+=t.charAt(i):r>2047?(e+=String.fromCharCode(224|r>>12&15),e+=String.fromCharCode(128|r>>6&63),e+=String.fromCharCode(128|r>>0&63)):(e+=String.fromCharCode(192|r>>6&31),e+=String.fromCharCode(128|r>>0&63));return e}function r(t){var e,i,o,r,a,l;for(o=t.length,i=0,e="";i<o;){if(r=255&t.charCodeAt(i++),i==o){e+=n.charAt(r>>2),e+=n.charAt((3&r)<<4),e+="==";break}if(a=t.charCodeAt(i++),i==o){e+=n.charAt(r>>2),e+=n.charAt((3&r)<<4|(240&a)>>4),e+=n.charAt((15&a)<<2),e+="=";break}l=t.charCodeAt(i++),e+=n.charAt(r>>2),e+=n.charAt((3&r)<<4|(240&a)>>4),e+=n.charAt((15&a)<<2|(192&l)>>6),e+=n.charAt(63&l)}return e}var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",a={chunkSize:4194304,maxRetryTimes:3,mkblk:[],mkfile:[]};if("https:"===window.location.protocol?(a.mkblk=["https://up.qbox.me/mkblk/","https://up-z1.qbox.me/mkblk/","https://up-z2.qbox.me/mkblk/"],a.mkfile=["https://up.qbox.me/mkfile/","https://up-z1.qbox.me/mkfile/","https://up-z2.qbox.me/mkfile/"]):(a.mkblk=["http://up.qiniu.com/mkblk/","http://up-z1.qiniu.com/mkblk/","http://up-z2.qiniu.com/mkblk/"],a.mkfile=["http://up.qiniu.com/mkfile/","http://up-z1.qiniu.com/mkfile/","http://up-z2.qiniu.com/mkfile/"]),this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),!this.support)return null;var l=function(t){return t.name+t.lastModified+t.size+t.type};this.upload=function(n){var u=e.defer(),s=u.promise,c=n.file;if(c){var p=l(c),f=i.get(p);f||(f=[]);var m,h=c.size+4194303>>22,d=function(t,e,i){return t[t.slice?"slice":t.mozSlice?"mozSlice":t.webkitSlice?"webkitSlice":"slice"](e,i)},k=function(t,e,i){return i===e-1?t.size-4194304*i:4194304},b=function(e,l){if(0!==l.length){for(var s,c="",f=0;f<l.length-1;f++)s=angular.fromJson(l[f]),c+=s.ctx+",";s=angular.fromJson(l[l.length-1]),c+=s.ctx;var m=a.mkfile[n.area||0]+e.size;n&&n.key&&(m+="/key/"+r(o(n.key))),t({url:m,method:"POST",data:c,headers:{Authorization:"UpToken "+n.token,"Content-Type":"text/plain"}}).then(function(t){u.resolve(t),i.remove(p)})["catch"](function(t){u.reject(t)})}},g=function(t,e,o){if(e===h)return void b(t,f);if(!o)return void u.reject("max retried,still failure");var r=k(t,h,e),l=4194304*e,s=d(t,l,l+r);m=new XMLHttpRequest,m.open("POST",a.mkblk[n.area||0]+r,!0),m.setRequestHeader("Authorization","UpToken "+n.token),m.upload.addEventListener("progress",function(e){if(e.lengthComputable){var i={totalSize:t.size,loaded:e.loaded+l};u.notify(i)}}),m.upload.onerror=function(){g(n.file,e,--o)},m.onreadystatechange=function(t){t&&4===m.readyState&&200===m.status&&(200===m.status?(f[e]=m.responseText,i.set(p,f),g(n.file,++e,a.maxRetryTimes)):g(n.file,e,--o))},m.send(s)};return g(n.file,f.length,a.maxRetryTimes),s.abort=function(){m.abort(),i.remove(p)},s.pause=function(){m.abort()},s}}}])}(),angular.module("angularQFileUpload").directive("ngFileSelect",["$parse","$timeout",function(t,e){return function(i,o,r){var n=t(r.ngFileSelect);if("input"!==o[0].tagName.toLowerCase()||"file"!==(o.attr("type")&&o.attr("type").toLowerCase())){for(var a=angular.element('<input type="file">'),l=0;l<o[0].attributes.length;l++)a.attr(o[0].attributes[l].name,o[0].attributes[l].value);o.attr("data-multiple")&&a.attr("multiple","true"),a.css("top",0).css("bottom",0).css("left",0).css("right",0).css("width","100%").css("opacity",0).css("position","absolute").css("filter","alpha(opacity=0)"),o.append(a),""!==o.css("position")&&"static"!==o.css("position")||o.css("position","relative"),o=a}o.bind("change",function(t){var o,r,a=[];if(o=t.__files_||t.target.files,null!==o)for(r=0;r<o.length;r++)a.push(o.item(r));e(function(){n(i,{$files:a,$event:t})})})}}]);